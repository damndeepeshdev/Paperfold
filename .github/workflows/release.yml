name: Release
on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  release:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        platform: [macos-latest, ubuntu-22.04, windows-latest]
    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies (Ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libsoup-3.0-dev libjavascriptcoregtk-4.1-dev

      - name: Rust setup
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target"

      - name: Sync node version and setup cache
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          cache: "npm" # or pnpm / yarn

      - name: Install frontend dependencies
        run: npm install # change this to npm ci if you have a lockfile

      - name: Build Sidecar
        run: |
          cargo build --release -p paperfold-daemon
          mkdir -p src-tauri/binaries

      - name: Prepare Sidecar (Unix)
        if: matrix.platform != 'windows-latest'
        run: |
          TRIPLE=$(rustc -vV | grep host | cut -d ' ' -f 2)
          echo "Detected triple: $TRIPLE"
          cp target/release/paperfold-daemon src-tauri/binaries/paperfold-daemon-$TRIPLE

      - name: Prepare Sidecar (Windows)
        if: matrix.platform == 'windows-latest'
        shell: bash
        run: |
          TRIPLE=$(rustc -vV | grep host | cut -d ' ' -f 2)
          echo "Detected triple: $TRIPLE"
          cp target/release/paperfold-daemon.exe src-tauri/binaries/paperfold-daemon-$TRIPLE.exe

      - name: Build the app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
          TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: "App v__VERSION__"
          releaseBody: |
            ## ðŸš€ Paperfold v0.1.5 - Phase 2: Performance & Polish

            ### âœ¨ New Features
            - **Detached WebDAV Sidecar**: The network drive daemon now runs independently and survives app restarts.
            - **Paperfold Network Drive**: Toggle the built-in WebDAV server directly from the sidebar.
            - **Mount URL Display**: Easily copy `http://127.0.0.1:17432` to mount your cloud drive.

            ### âš¡ Performance
            - **Database Concurrency**: Replaced Mutex with `RwLock` for non-blocking database reads. Browse files while uploading!
            - **Persistent Caching**: File previews are now cached in `AppSupport/cache`, significantly reducing bandwidth usage and preview capability.

            ### ðŸ› ï¸ Fixes & Portability
            - **Cross-Platform**: Automated builds for macOS (Universal), Linux (AppImage), and Windows (Exe).
            - **Correct Timestamps**: Files now display accurate creation/modification dates.
            - **Wayland Support**: Fix for black screen issues on Linux (Wayland).
          releaseDraft: false
          prerelease: false

      - name: Sign Artifacts
        shell: bash
        env:
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
        run: |
          # Sign DMG on macOS
          if [ "$RUNNER_OS" == "macOS" ]; then
             echo "Signing macOS artifacts..."
             npm run tauri signer sign -- -k "$(echo "$TAURI_PRIVATE_KEY" | tr -d '\n')" --password "$TAURI_KEY_PASSWORD" src-tauri/target/release/bundle/dmg/*.dmg
          # Sign AppImage/Deb/Rpm on Linux
          elif [ "$RUNNER_OS" == "Linux" ]; then
             echo "Signing Linux artifacts..."
             npm run tauri signer sign -- -k "$(echo "$TAURI_PRIVATE_KEY" | tr -d '\n')" --password "$TAURI_KEY_PASSWORD" src-tauri/target/release/bundle/appimage/*.AppImage 2>/dev/null || true
             npm run tauri signer sign -- -k "$(echo "$TAURI_PRIVATE_KEY" | tr -d '\n')" --password "$TAURI_KEY_PASSWORD" src-tauri/target/release/bundle/deb/*.deb 2>/dev/null || true
             npm run tauri signer sign -- -k "$(echo "$TAURI_PRIVATE_KEY" | tr -d '\n')" --password "$TAURI_KEY_PASSWORD" src-tauri/target/release/bundle/rpm/*.rpm 2>/dev/null || true
          # Sign Exe/Msi on Windows
          elif [ "$RUNNER_OS" == "Windows" ]; then
             echo "Signing Windows artifacts..."
             npm run tauri signer sign -- -k "$(echo "$TAURI_PRIVATE_KEY" | tr -d '\n')" --password "$TAURI_KEY_PASSWORD" src-tauri/target/release/bundle/nsis/*.exe 2>/dev/null || true
             npm run tauri signer sign -- -k "$TAURI_PRIVATE_KEY" --password "$TAURI_KEY_PASSWORD" src-tauri/target/release/bundle/msi/*.msi 2>/dev/null || true
          fi

      - name: Upload Signatures
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "$RUNNER_OS" == "macOS" ]; then
             gh release upload ${{ github.ref_name }} src-tauri/target/release/bundle/dmg/*.sig
          elif [ "$RUNNER_OS" == "Linux" ]; then
             gh release upload ${{ github.ref_name }} src-tauri/target/release/bundle/appimage/*.sig src-tauri/target/release/bundle/deb/*.sig src-tauri/target/release/bundle/rpm/*.sig 2>/dev/null || true
          elif [ "$RUNNER_OS" == "Windows" ]; then
             gh release upload ${{ github.ref_name }} src-tauri/target/release/bundle/nsis/*.sig src-tauri/target/release/bundle/msi/*.sig 2>/dev/null || true
          fi

  publish-latest-json:
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"

      - name: Generate and Upload latest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: node .github/scripts/generate-latest.mjs
